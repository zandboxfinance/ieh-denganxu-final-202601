<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>404è™Ÿæ˜Ÿéš›ç«™ - AI å°ˆé¡Œ</title>
    <style>
        :root { --main-cyan: #00ffcc; --bg-dark: #0d1117; }
        body {
            background-color: var(--bg-dark);
            color: var(--main-cyan);
            font-family: 'Courier New', monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            transition: 0.5s;
        }
       
        /* å•†åº—è£ä¿® - éœ“è™¹ç´«ä¸»é¡Œ */
        body.theme-purple { --main-cyan: #ff00ff; --bg-dark: #1a001a; }


        /* ç´…å…‰é–ƒçˆå‹•ç•« */
        @keyframes neon-red-flash {
            0% { background-color: #0d1117; box-shadow: inset 0 0 20px #ff0000; }
            50% { background-color: #330000; box-shadow: inset 0 0 60px #ff0000; }
            100% { background-color: #0d1117; box-shadow: inset 0 0 20px #ff0000; }
        }


        .danger-mode {
            animation: neon-red-flash 0.6s infinite;
            --main-cyan: #ff4444 !important;
        }


        #status-bar { width: 800px; padding: 10px; border-bottom: 2px solid var(--main-cyan); display: flex; justify-content: space-between; font-size: 18px; }
        .nav-buttons { margin: 10px 0; }
        button.nav-btn { background: #000; border: 2px solid var(--main-cyan); color: var(--main-cyan); padding: 5px 12px; cursor: pointer; margin: 0 5px; font-weight: bold; }
        button.nav-btn:hover { background: var(--main-cyan); color: black; }


        #main-container { width: 800px; height: 450px; border: 4px solid #444; position: relative; background: #000; }
       
        .panel { width: 100%; height: 100%; display: none; position: absolute; top: 0; left: 0; background: #000; box-sizing: border-box; overflow-y: auto; padding: 20px; }
        .active { display: block !important; z-index: 10; }
       
        #chat-panel { display: flex; flex-direction: column; padding: 10px; }
        #chat-box { flex-grow: 1; height: 280px; overflow-y: auto; border: 1px solid #333; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.8); }
        .input-area { display: flex; gap: 5px; }
        #player-input { flex-grow: 1; background: #222; border: 1px solid var(--main-cyan); color: white; padding: 10px; }


        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; }
        .shop-item { border: 1px dashed var(--main-cyan); padding: 10px; }


        canvas { display: block; background: #111; }
        .npc-msg { color: #ffcc00; margin-bottom: 10px; }
        .player-msg { color: #fff; text-align: right; margin-bottom: 10px; }
        #battle-ui { position: absolute; top: 10px; left: 10px; color: white; pointer-events: none; z-index: 20; }
    </style>
</head>
<body>


<div id="status-bar">
    <div>$ <span id="money-val">1000</span> | ğŸ’Šx<span id="kit-val">0</span> | ğŸ›¡ï¸x<span id="shd-val">0</span></div>
    <div>ç«™å°ç­‰ç´š: <span id="level-val">1</span> | ç ²å¡”: <span id="turret-val">ç„¡</span></div>
</div>


<div class="nav-buttons">
    <button class="nav-btn" onclick="showPanel('chat-panel')">(Q) å°è©±</button>
    <button class="nav-btn" onclick="showPanel('inventory-panel')">(B) èƒŒåŒ…</button>
    <button class="nav-btn" onclick="showPanel('shop-panel')">(S) å•†åº—</button>
    <button class="nav-btn" onclick="showPanel('weapon-panel')">(X) æ­¦å™¨</button>
</div>


<div id="main-container">
    <div id="chat-panel" class="panel active">
        <div id="chat-box"><div class="npc-msg">ç³»çµ±ï¼šæ­¡è¿å›åˆ° 404 è™Ÿç«™ã€‚</div></div>
        <div class="input-area">
            <input type="text" id="player-input" placeholder="å°è©±æˆ–è¼¸å…¥ 'æ–°è'..." onkeypress="if(event.key==='Enter') talkToGemini()">
            <button class="nav-btn" onclick="talkToGemini()">ç™¼é€</button>
        </div>
    </div>


    <div id="shop-panel" class="panel">
        <h2>--- æ˜Ÿéš›æ“´å……å•†åº— ---</h2>
        <div class="shop-grid">
            <div class="shop-item">
                <p>æ€¥æ•‘è—¥åŒ… ($200)</p>
                <button class="nav-btn" onclick="buyItem('kit')">è³¼è²· (æˆ°é¬¥ä¸­æŒ‰ H å›è¡€)</button>
            </div>
            <div class="shop-item">
                <p>é˜²è­·ç½©æ’ä»¶ ($300)</p>
                <button class="nav-btn" onclick="buyItem('shd')">è³¼è²· (æˆ°é¬¥ä¸­æŒ‰ G ç„¡æ•µ 3s)</button>
            </div>
            <div class="shop-item">
                <p>è‡ªå‹•é˜²ç¦¦ç ²å¡” ($1500)</p>
                <button class="nav-btn" onclick="buyItem('turret')">å®‰è£ç³»çµ±</button>
            </div>
            <div class="shop-item">
                <p>å•†åº—è£ä¿® ($2000)</p>
                <button class="nav-btn" onclick="changeTheme()">åˆ‡æ›éœ“è™¹é¢¨æ ¼</button>
            </div>
            <div class="shop-item">
                <p>è³¼è²·æ˜Ÿéš›æ–°è ($100)</p>
                <button class="nav-btn" onclick="buyNews()">ç²å–æœ€æ–°æƒ…å ±</button>
            </div>
        </div>
    </div>


    <div id="weapon-panel" class="panel">
        <h2>--- æ­¦å™¨æ•´å‚™ç³»çµ± ---</h2>
        <p>ç›®å‰å¨åŠ›ï¼š<span id="atk-val">10</span></p>
        <button class="nav-btn" onclick="upgradeWeapon()">èŠ±è²» $500 æå‡ç«åŠ›</button>
    </div>


    <div id="inventory-panel" class="panel">
        <h2>--- å€‹äººèƒŒåŒ… ---</h2>
        <p>è‡ªå‹•ç¿»è­¯æ©Ÿï¼šå·²å®‰è£</p>
        <p>æ€¥æ•‘è—¥åŒ…ï¼š<span id="kit-count">0</span></p>
        <p>é˜²è­·ç½©æ’ä»¶ï¼š<span id="shd-count">0</span></p>
    </div>


    <div id="battle-panel" class="panel" style="padding:0;">
        <div id="battle-ui">HP: <span id="hp-val">100</span> | â±ï¸: <span id="timer-val">45</span> | ç›¾: <span id="shd-active">é—œé–‰</span></div>
        <canvas id="gameCanvas" width="800" height="450"></canvas>
    </div>
</div>


<script>
// --- æ ¸å¿ƒè³‡æ–™ ---
let money = 1000, atk = 10, kits = 0, shds = 0, hasTurret = false, shieldTimer = 0;
let gameActive = false, battleTimer = 45, timerInterval;


// [é‡è¦] è«‹åœ¨æ­¤æ›¿æ›ä½ çš„ API KEY
const API_KEY = "AIzaSyAsq5fDEYoUzHk6lQy2zkC1QLO0Oh9Nr44";
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;


// --- ä»‹é¢æ§åˆ¶ ---
function showPanel(id) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    gameActive = (id === 'battle-panel');
    if(gameActive) startBattle();
}


function updateUI() {
    document.getElementById('money-val').innerText = money;
    document.getElementById('atk-val').innerText = atk;
    document.getElementById('kit-val').innerText = kits;
    document.getElementById('kit-count').innerText = kits;
    document.getElementById('shd-val').innerText = shds;
    document.getElementById('shd-count').innerText = shds;
    document.getElementById('turret-val').innerText = hasTurret ? "å·²å®‰è£" : "ç„¡";
}


// --- å•†åº—åŠŸèƒ½ ---
function buyItem(type) {
    if(type==='kit' && money>=200) { money-=200; kits++; }
    else if(type==='shd' && money>=300) { money-=300; shds++; }
    else if(type==='turret' && money>=1500) { money-=1500; hasTurret=true; }
    else { alert("éŒ¢ä¸å¤ æˆ–æ¢ä»¶ä¸ç¬¦ï¼"); return; }
    updateUI();
}


function changeTheme() {
    if(money>=2000) { money-=2000; document.body.classList.toggle('theme-purple'); updateUI(); }
}


async function buyNews() {
    if(money>=100) {
        money-=100; updateUI();
        talkToGemini("è«‹å‘Šè¨´æˆ‘ä¸€äº›é—œæ–¼å®‡å®™æˆ°çˆ­æˆ–é»‘å¸‚äº¤æ˜“çš„æœ€æ–°æƒ…å ±ã€‚");
    }
}


function upgradeWeapon() {
    if(money>=500) { money-=500; atk+=5; updateUI(); }
}


// --- æˆ°é¬¥èˆ‡ç•«å¸ƒç³»çµ± ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const player = { x: 50, y: 350, w: 30, h: 45, vy: 0, hp: 100, grounded: true };
const bullets = [], enemies = [], keys = {};


window.onkeydown = e => {
    keys[e.code] = true;
    if(e.code === 'KeyZ' && gameActive) shoot();
    if(e.code === 'KeyH' && gameActive && kits>0) { player.hp=Math.min(100, player.hp+30); kits--; updateUI(); }
    if(e.code === 'KeyG' && gameActive && shds>0) { shieldTimer=180; shds--; updateUI(); }
};
window.onkeyup = e => keys[e.code] = false;


function shoot() { bullets.push({ x: player.x+30, y: player.y+20, w:10, h:4, speed:12 }); }


function startBattle() {
    player.hp = 100; battleTimer = 45; enemies.length = 0; bullets.length = 0;
    document.getElementById('hp-val').innerText = player.hp;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        battleTimer--;
        document.getElementById('timer-val').innerText = battleTimer;
        if(battleTimer <= 0) endBattle("å¤–æ˜Ÿäººæ’¤é€€äº†ï¼");
    }, 1000);
    requestAnimationFrame(loop);
}


function endBattle(msg) {
    gameActive = false;
    clearInterval(timerInterval);
    document.body.classList.remove('danger-mode'); // æ¢å¾©æ­£å¸¸å…‰ç·š
    alert(msg);
    showPanel('chat-panel');
}


function loop() {
    if(!gameActive) return;
    // ç‰©ç†ç§»å‹•
    if(keys['ArrowLeft']) player.x -= 6;
    if(keys['ArrowRight']) player.x += 6;
    if(keys['ArrowUp'] && player.grounded) { player.vy = -12; player.grounded = false; }
    player.vy += 0.6; player.y += player.vy;
    if(player.y > 350) { player.y = 350; player.vy = 0; player.grounded = true; }


    // è‡ªå‹•ç ²å¡”é‚è¼¯
    if(hasTurret && Math.random() < 0.05) shoot();


    // å­å½ˆè™•ç†
    for(let i = bullets.length - 1; i >= 0; i--) {
        bullets[i].x += bullets[i].speed;
        if(bullets[i].x > 800) bullets.splice(i, 1);
    }


    // æ•µäººè™•ç†èˆ‡ç¢°æ’
    if(Math.random() < 0.04) enemies.push({ x:800, y:Math.random()>0.5?350:250, w:30, h:30 });
   
    for(let ei = enemies.length - 1; ei >= 0; ei--) {
        let en = enemies[ei];
        en.x -= 5;


        // ç©å®¶ç¢°æ’æ•µäºº
        if(hit(player, en)) {
            if(shieldTimer <= 0) {
                player.hp -= 15;
                document.getElementById('hp-val').innerText = player.hp;
            }
            enemies.splice(ei, 1);
            if(player.hp <= 0) { endBattle("é˜²ç·šå´©æ½°ï¼"); return; }
            continue;
        }


        // å­å½ˆç¢°æ’æ•µäºº
        for(let bi = bullets.length - 1; bi >= 0; bi--) {
            if(hit(bullets[bi], en)) {
                enemies.splice(ei, 1);
                bullets.splice(bi, 1);
                money += 30;
                updateUI();
                break;
            }
        }
    }


    if(shieldTimer > 0) shieldTimer--;
    document.getElementById('shd-active').innerText = shieldTimer > 0 ? "å•Ÿå‹•" : "é—œé–‰";


    draw();
    requestAnimationFrame(loop);
}


function draw() {
    ctx.clearRect(0, 0, 800, 450);
    ctx.fillStyle="#333"; ctx.fillRect(0, 395, 800, 55);
   
    // ç©å®¶
    ctx.fillStyle = shieldTimer > 0 ? "cyan" : (atk >= 20 ? "magenta" : "blue");
    ctx.fillRect(player.x, player.y, player.w, player.h);
    if(shieldTimer > 0) { ctx.strokeStyle = "white"; ctx.strokeRect(player.x-5, player.y-5, player.w+10, player.h+10); }
   
    // å­å½ˆèˆ‡æ•µäºº
    ctx.fillStyle = "yellow"; bullets.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));
    ctx.fillStyle = "red"; enemies.forEach(en => ctx.fillRect(en.x, en.y, en.w, en.h));
}


function hit(a, b) { return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }


// --- AI é€šè¨Šç³»çµ± ---
async function talkToGemini(customPrompt) {
    const input = document.getElementById('player-input');
    const text = customPrompt || input.value;
    if(!text) return;


    appendMsg('player-msg', "ä½ : " + text);
    input.value = "";


    // æº–å‚™å‚³é€çµ¦ AI çš„ Prompt
    const systemPrompt = `ä½ æ˜¯ä¸€å€‹æœ«æ—¥å¤ªç©ºç«™ã€Œ404è™Ÿç«™ã€çš„å¤–æ˜Ÿå•†è²©ï¼Œè„¾æ°£é™°æ™´ä¸å®šã€‚ç©å®¶ç¾åœ¨è·Ÿä½ èªªï¼š'${text}'ã€‚è«‹å›ç­”ç©å®¶ï¼Œä¸¦åœ¨å›ç­”çš„æœ€å¾Œåš´æ ¼éµå®ˆæ ¼å¼é™„å¸¶ [ANGRY:0-100] çš„æ•¸å€¼ã€‚è‹¥æ•¸å€¼å¤§æ–¼ 90 ä½ æœƒé–‹ç«ã€‚`;


    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: systemPrompt }] }]
            })
        });


        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text;
        appendMsg('npc-msg', "å¤–æ˜Ÿäºº: " + aiText);


        // è§£ææ†¤æ€’å€¼
        const angryMatch = aiText.match(/\[ANGRY:(\d+)\]/);
        if (angryMatch) {
            const angryVal = parseInt(angryMatch[1]);
           
            // é‚è¼¯åˆ¤æ–·ï¼šé«˜æ–¼ 80 é–ƒç´…ç‡ˆï¼Œé«˜æ–¼ 90 é€²å…¥æˆ°é¬¥
            if (angryVal >= 80) {
                document.body.classList.add('danger-mode');
                if (angryVal >= 90) {
                    appendMsg('npc-msg', "ç³»çµ±ï¼šè­¦å‘Šï¼å¤–æ˜Ÿäººç™¼èµ·æ”»æ“Šï¼");
                    setTimeout(() => { showPanel('battle-panel'); }, 1500);
                }
            } else {
                document.body.classList.remove('danger-mode');
            }
        }
    } catch(e) {
        appendMsg('npc-msg', "ç³»çµ±ï¼šé€šè¨Šé›œè¨Š... (è«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢º)");
        console.error(e);
    }
}


function appendMsg(cls, txt) {
    const box = document.getElementById('chat-box');
    const d = document.createElement('div'); d.className = cls; d.innerText = txt;
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
}
</script>


</body>
</html>
